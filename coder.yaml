version: "3.9"
networks:
  reverse-proxy:
    external: true
services:
  coder:
    image: ghcr.io/coder/coder:latest
    user: "1000:131" #groupid needs to be the host's docker group
    networks:
      reverse-proxy:
    ports:
      - "7080:7080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "/mnt/user/docker/volumes/coder:/home/coder"
    environment:
      #CODER_PG_CONNECTION_URL: "postgresql://${PGUSER}:${PGPASS}@${PGHOST}:${PGPORT}/${PGDATABASE}?sslmode=disable"
      CODER_HTTP_ADDRESS: "0.0.0.0:7080"
      CODER_ACCESS_URL: "https://coder.actuary.dev"
      CODER_WILDCARD_ACCESS_URL: "*.coder.actuary.dev"
      group-add: "131" #docker group on host, not sure if this is needed
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.coder.rule=Host(`coder.actuary.dev`)"
        - "traefik.http.routers.coder.entrypoints=websecure"
        - "traefik.http.routers.coder.service=coder"
        - "traefik.http.routers.coder.tls.certresolver=myresolver"
        - "traefik.http.services.coder.loadbalancer.server.port=7080"
        - "traefik.http.middlewares.coder.headers.customrequestheaders.Upgrade=websocket"
        - "traefik.http.middlewares.coder.headers.customrequestheaders.Connection=Upgrade"
        ## Middlewares
#        - "traefik.http.routers.coder.middlewares=authentik@file"
